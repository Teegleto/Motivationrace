<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>race</title>
  <meta name="description" content="Fullscreen word cycler with hidden admin editing and dual quote sets." />

  <style>
    :root { --bg:#fff; --fg:#111; --muted:#e5e7eb; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:flex; align-items:center; justify-content:center;
      -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none;
    }

    .container{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:2rem;
      padding:2rem;
      max-width:90vw;
    }

    #word{
      margin:0;
      font-weight:700;
      font-size:clamp(3rem,10vw,6rem);
      line-height:1.1;
      word-break:break-word;
    }

    #nextBtn{
      appearance:none;
      background:#f8f9fb;
      border:1px solid var(--muted);
      color:var(--fg);
      padding:0.9rem 1.4rem;
      border-radius:999px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:background 120ms ease, transform 120ms ease;
    }
    #nextBtn:hover{ background:#f1f3f7; }
    #nextBtn:active{ transform:translateY(1px); }

    /* Invisible hotspots.
       While testing you can add border/background to see them.
       Bottom-right = edit quotes for current mode.
       Bottom-left  = toggle modes (main <-> alt). */
    #hotspotMainEdit,
    #hotspotAltMode {
      position:fixed;
      width:max(1in,96px);
      height:max(1in,96px);
      background:transparent;
      border:none;
      opacity:0;          /* invisible but clickable */
      cursor:pointer;
      z-index:2147483647;
      pointer-events:auto;
    }

    #hotspotMainEdit{
      right:0.3in;
      bottom:0.3in;
    }

    #hotspotAltMode{
      left:0.3in;
      bottom:0.3in;
    }

    /* Modal overlay */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2147483000;
    }
    .backdrop[aria-hidden="false"]{ display:flex; }

    .modal{
      width:min(92vw,640px);
      background:var(--bg);
      color:var(--fg);
      border:1px solid var(--muted);
      border-radius:16px;
      padding:1.25rem;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      margin-bottom:.75rem;
    }

    .title{
      font-size:1.1rem;
      font-weight:700;
      margin:0;
    }

    .closeBtn{
      appearance:none;
      background:transparent;
      border:1px solid var(--muted);
      border-radius:10px;
      padding:.35rem .6rem;
      cursor:pointer;
      font-weight:600;
    }

    .modalBody{ display:grid; gap:.9rem; }
    .stack{ display:grid; gap:.5rem; }
    .row{ display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .label{ font-size:.9rem; opacity:.8; }

    /* Inputs/buttons */
    .input,
    .token{
      width:100%;
      padding:.8rem .9rem;
      border-radius:12px;
      border:1px solid var(--muted);
      font:inherit;
      color:var(--fg);
      background:#fff;
      caret-color:auto;
      -webkit-user-select:text;
      -moz-user-select:text;
      user-select:text;
    }

    .small{ font-size:.85rem; opacity:.75; }

    .btn{
      appearance:none;
      border:1px solid var(--muted);
      background:#f8f9fb;
      color:var(--fg);
      padding:.7rem 1rem;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:background 120ms ease, transform 120ms ease;
    }
    .btn:hover{ background:#f1f3f7; }
    .btn:active{ transform:translateY(1px); }

    .danger{
      border-color:#ef4444;
      color:#ef4444;
      background:#fff;
    }
    .danger:hover{ background:#fff2f2; }

    .error{ color:#b00020; min-height:1.2em; }
    .ok{ color:#16a34a; min-height:1.2em; }

    .list{
      margin:0;
      padding-left:1.1rem;
    }
    .list li{
      margin:.2rem 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem;
    }

    .pill{
      padding:.2rem .6rem;
      border:1px solid var(--muted);
      border-radius:999px;
      font-size:.8rem;
    }

    @media (prefers-color-scheme:dark){
      :root{ --bg:#111; --fg:#fff; --muted:#2b2b2b; }
      #nextBtn, .btn{
        background:#1e1e1e;
        border-color:var(--muted);
        color:#fff;
      }
      #nextBtn:hover, .btn:hover{ background:#242424; }
      .modal{ background:#151515; }
      .input, .token{
        background:#0f0f0f;
        border-color:var(--muted);
        color:#fff;
      }
      .closeBtn{
        border-color:var(--muted);
        color:#fff;
      }
      .closeBtn:hover{
        background:#1e1e1e;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="word">race</h1>
    <button id="nextBtn" type="button">Change word</button>
  </div>

  <!-- Bottom-right hotspot: edit quotes for current mode -->
  <button id="hotspotMainEdit" aria-label="Open editor"></button>

  <!-- Bottom-left hotspot: toggle mode (main <-> alt) -->
  <button id="hotspotAltMode" aria-label="Toggle alt mode"></button>

  <!-- Shared modal -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <h2 class="title" id="modalTitle">Admin</h2>
        <button class="closeBtn" id="closeModal" type="button">Close</button>
      </div>

      <div class="modalBody" id="modalBody">
        <!-- Auth view -->
        <div class="stack" id="authView">
          <div class="label" id="authLabel">Enter password</div>
          <input class="input" id="pwd" type="password" placeholder="••••••••" autocomplete="off" />
          <div class="row">
            <button class="btn" id="submitPwd" type="button">Submit</button>
          </div>
          <div class="error" id="err"></div>
          <div class="small" id="authHint"></div>
        </div>

        <!-- Quotes edit view -->
        <div class="stack" id="listView" style="display:none;">
          <div class="row" style="justify-content:space-between; width:100%;">
            <div class="label" id="quotesHeading">Quotes</div>
            <button class="btn" id="openSettings" type="button">Settings</button>
          </div>

          <ul class="list" id="quoteList"></ul>

          <div class="row" style="align-items:flex-start; width:100%;">
            <input class="input" id="newQuote" type="text" placeholder="Add a new quote…" />
            <button class="btn" id="addQuote" type="button">Add</button>
          </div>

          <div class="row" style="justify-content:space-between; width:100%;">
            <span class="small">
              Saving updates writes to <code id="whichFileLabel">quotes_main.json</code> in this repo.
            </span>
            <button class="btn" id="saveQuotes" type="button">Save to GitHub</button>
          </div>

          <div class="error" id="saveErr"></div>
          <div class="ok" id="saveOk"></div>
        </div>

        <!-- Settings password gate -->
        <div class="stack" id="settingsAuthView" style="display:none;">
          <div class="label">Enter settings password</div>
          <input class="input" id="settingsPwd" type="password" placeholder="••••••••" autocomplete="off" />
          <div class="row">
            <button class="btn" id="submitSettingsPwd" type="button">Unlock Settings</button>
          </div>
          <div class="error" id="settingsErr"></div>
          <div class="small">This protects the GitHub token. Password is "quack".</div>
          <div class="row">
            <button class="btn" id="cancelSettingsAuth" type="button">← Back</button>
          </div>
        </div>

        <!-- Settings view (GitHub token etc) -->
        <div class="stack" id="settingsView" style="display:none;">
          <div class="label">GitHub Settings</div>
          <div class="small">
            Use a fine-grained token with Repository permissions → Contents: Read and write. Scoped to just this repo.
          </div>

          <input class="token" id="ghToken" type="password" placeholder="GitHub token (saved locally on this device)" />
          <div class="row">
            <input class="input" id="ghOwner" placeholder="GitHub owner (e.g. teegleto)" />
            <input class="input" id="ghRepo" placeholder="Repo name (e.g. race-site)" />
            <input class="input" id="ghBranch" placeholder="Branch (e.g. main)" />
          </div>

          <div class="row" style="justify-content:space-between; width:100%;">
            <button class="btn" id="saveSettings" type="button">Save settings</button>
            <button class="btn danger" id="clearSettings" type="button">Clear token</button>
            <span class="pill" id="settingsStatus">Not saved</span>
          </div>
          <div class="row">
            <button class="btn" id="backToList" type="button">← Back</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ===========================
     CONFIG / PASSWORDS
     =========================== */

  // Password to EDIT main quotes
  const PASS_MAIN_EDIT = "race-admin";

  // Password to view alt mode AND edit alt quotes
  const PASS_ALT = "woke";

  // Password to unlock GitHub token settings
  const PASS_SETTINGS = "quack";

  // Files in repo
  const FILE_MAIN = "quotes_main.json";
  const FILE_ALT  = "quotes_alt.json";

  /* ===========================
     STATE
     =========================== */

  // MODE is not persisted anymore.
  // Page load always starts in normal ("main") mode.
  let MODE = "main";

  // quotes in current mode
  let QUOTES = [];
  let WORD = "race";

  // For modal logic
  // "edit-main", "edit-alt", "switch-alt", "settings-auth"
  let currentFlow = null;

  /* ===========================
     DOM LOOKUPS
     =========================== */

  const wordEl = document.getElementById("word");
  const nextBtn = document.getElementById("nextBtn");

  const hotspotMainEdit = document.getElementById("hotspotMainEdit");
  const hotspotAltMode  = document.getElementById("hotspotAltMode");

  const backdrop = document.getElementById("backdrop");
  const closeModalBtn = document.getElementById("closeModal");
  const modalTitle = document.getElementById("modalTitle");

  // views
  const authView = document.getElementById("authView");
  const listView = document.getElementById("listView");
  const settingsAuthView = document.getElementById("settingsAuthView");
  const settingsView = document.getElementById("settingsView");

  // auth controls
  const authLabel = document.getElementById("authLabel");
  const authHint = document.getElementById("authHint");
  const pwdInput = document.getElementById("pwd");
  const submitPwd = document.getElementById("submitPwd");
  const err = document.getElementById("err");

  // quotes editor
  const quoteList = document.getElementById("quoteList");
  const newQuote = document.getElementById("newQuote");
  const addQuote = document.getElementById("addQuote");
  const saveQuotesBtn = document.getElementById("saveQuotes");
  const saveErr = document.getElementById("saveErr");
  const saveOk = document.getElementById("saveOk");
  const whichFileLabel = document.getElementById("whichFileLabel");
  const quotesHeading = document.getElementById("quotesHeading");

  // settings section
  const openSettingsBtn = document.getElementById("openSettings");
  const settingsPwd = document.getElementById("settingsPwd");
  const submitSettingsPwd = document.getElementById("submitSettingsPwd");
  const settingsErr = document.getElementById("settingsErr");
  const cancelSettingsAuth = document.getElementById("cancelSettingsAuth");

  // settings view controls
  const ghToken = document.getElementById("ghToken");
  const ghOwner = document.getElementById("ghOwner");
  const ghRepo = document.getElementById("ghRepo");
  const ghBranch = document.getElementById("ghBranch");
  const saveSettingsBtn = document.getElementById("saveSettings");
  const clearSettingsBtn = document.getElementById("clearSettings");
  const settingsStatus = document.getElementById("settingsStatus");
  const backToListBtn = document.getElementById("backToList");

  /* ===========================
     HELPERS
     =========================== */

  function fileForMode(m){
    return m === "alt" ? FILE_ALT : FILE_MAIN;
  }

  function modeLabel(m){
    return m === "alt" ? "Alt Quotes" : "Main Quotes";
  }

  function pickNext(current) {
    const choices = QUOTES.filter(w => w !== current);
    if (!choices.length) return current;
    return choices[Math.floor(Math.random() * choices.length)];
  }

  function renderList() {
    quoteList.innerHTML = "";
    QUOTES.forEach((q, idx) => {
      const li = document.createElement("li");

      const span = document.createElement("span");
      span.textContent = q;

      const del = document.createElement("button");
      del.textContent = "Remove";
      del.className = "btn danger";
      del.addEventListener("click", () => {
        QUOTES.splice(idx,1);
        renderList();
      });

      li.appendChild(span);
      li.appendChild(del);
      quoteList.appendChild(li);
    });

    whichFileLabel.textContent = fileForMode(MODE);
    quotesHeading.textContent = modeLabel(MODE);
  }

  function utf8ToBase64(str) {
    const bytes = new TextEncoder().encode(str);
    let binary = "";
    bytes.forEach(b => binary += String.fromCharCode(b));
    return btoa(binary);
  }

  async function fetchQuotesForMode(m){
    const file = fileForMode(m);
    try {
      const res = await fetch(file + "?ts=" + Date.now(), { cache:"no-store" });
      const data = await res.json();
      if (Array.isArray(data) && data.length){
        return data.slice();
      } else {
        if (m === "alt"){
          return ["alt quote 1","alt quote 2","alt quote 3"];
        } else {
          return ["race","Woke","quack","waw","teenage tech"];
        }
      }
    } catch(e){
      if (m === "alt"){
        return ["alt quote 1","alt quote 2","alt quote 3"];
      } else {
        return ["race","Woke","quack","waw","teenage tech"];
      }
    }
  }

  async function refreshModeData() {
    QUOTES = await fetchQuotesForMode(MODE);
    WORD = QUOTES[0] || "race";
    wordEl.textContent = WORD;
  }

  async function getFileSha(owner, repo, path, branch) {
    const token = localStorage.getItem("gh_token") || "";
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const res = await fetch(url, {
      headers: {
        "Accept":"application/vnd.github+json",
        ...(token ? {"Authorization":`Bearer ${token}`} : {})
      },
      cache:"no-store"
    });
    if (!res.ok) throw new Error("Failed to get file info: " + res.status);
    const json = await res.json();
    return json.sha;
  }

  async function putFile(owner, repo, path, branch, message, contentB64, sha) {
    const token = localStorage.getItem("gh_token") || "";
    if (!token) throw new Error("Missing GitHub token.");

    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body = { message, content:contentB64, branch };
    if (sha) body.sha = sha;

    const res = await fetch(url, {
      method:"PUT",
      headers:{
        "Accept":"application/vnd.github+json",
        "Authorization":`Bearer ${token}`,
        "Content-Type":"application/json"
      },
      body: JSON.stringify(body)
    });

    if (!res.ok){
      const txt = await res.text();
      throw new Error("GitHub save failed: " + res.status + " " + txt);
    }
    return res.json();
  }

  function loadSettings(){
    ghToken.value  = localStorage.getItem("gh_token")   || "";
    ghOwner.value  = localStorage.getItem("gh_owner")   || "";
    ghRepo.value   = localStorage.getItem("gh_repo")    || "";
    ghBranch.value = localStorage.getItem("gh_branch")  || "main";
    settingsStatus.textContent = ghToken.value ? "Token saved" : "Not saved";
  }

  function saveSettings(){
    // Persist in localStorage so this browser keeps it after reload.
    // NOTE: cannot sync this safely to other devices without exposing your token publicly.
    localStorage.setItem("gh_token",  ghToken.value.trim());
    localStorage.setItem("gh_owner",  ghOwner.value.trim());
    localStorage.setItem("gh_repo",   ghRepo.value.trim());
    localStorage.setItem("gh_branch", ghBranch.value.trim() || "main");
    settingsStatus.textContent = ghToken.value ? "Token saved" : "Not saved";
  }

  function clearSettings(){
    localStorage.removeItem("gh_token");
    settingsStatus.textContent = "Token cleared";
    ghToken.value = "";
  }

  /* ===========================
     MODAL / VIEW CONTROL
     =========================== */

  function openBackdrop(){
    backdrop.setAttribute("aria-hidden","false");
  }
  function closeBackdrop(){
    backdrop.setAttribute("aria-hidden","true");
  }

  function showAuthView(flow){
    currentFlow = flow;
    authView.style.display = "";
    listView.style.display = "none";
    settingsAuthView.style.display = "none";
    settingsView.style.display = "none";

    saveErr.textContent = "";
    saveOk.textContent = "";
    err.textContent = "";
    pwdInput.value = "";

    if (flow === "edit-main"){
      modalTitle.textContent = "Admin (main)";
      authLabel.textContent = "Enter password";
      authHint.textContent = "Password is '" + PASS_MAIN_EDIT + "'";
    } else if (flow === "edit-alt"){
      modalTitle.textContent = "Admin (alt)";
      authLabel.textContent = "Enter password";
      authHint.textContent = "Password is '" + PASS_ALT + "'";
    } else if (flow === "switch-alt"){
      modalTitle.textContent = "Alt Mode";
      authLabel.textContent = "Enter alt mode password";
      authHint.textContent = "Password is '" + PASS_ALT + "'";
    } else if (flow === "settings-auth"){
      showSettingsAuthView();
      return;
    }

    openBackdrop();
    setTimeout(()=>pwdInput.focus(),0);
  }

  function showListView(){
    currentFlow = "list";
    authView.style.display = "none";
    listView.style.display = "";
    settingsAuthView.style.display = "none";
    settingsView.style.display = "none";

    modalTitle.textContent = modeLabel(MODE);
    renderList();
  }

  function showSettingsAuthView(){
    currentFlow = "settings-auth";
    authView.style.display = "none";
    listView.style.display = "none";
    settingsAuthView.style.display = "";
    settingsView.style.display = "none";

    settingsErr.textContent = "";
    settingsPwd.value = "";

    modalTitle.textContent = "Settings Lock";
    openBackdrop();
    setTimeout(()=>settingsPwd.focus(),0);
  }

  function showSettingsView(){
    currentFlow = "settings";
    loadSettings();

    authView.style.display = "none";
    listView.style.display = "none";
    settingsAuthView.style.display = "none";
    settingsView.style.display = "";

    modalTitle.textContent = "Settings";
  }

  /* ===========================
     ACTION WIRING
     =========================== */

  // Bottom-right hotspot:
  // If MODE="main" -> require PASS_MAIN_EDIT, then open editor for main
  // If MODE="alt"  -> require PASS_ALT, then open editor for alt
  hotspotMainEdit.addEventListener("click", () => {
    if (MODE === "alt"){
      showAuthView("edit-alt");
    } else {
      showAuthView("edit-main");
    }
  });

  // Bottom-left hotspot:
  // If MODE="main": ask for PASS_ALT ("woke") to switch into alt mode
  // If MODE="alt": instantly switch back to main mode with NO password
  hotspotAltMode.addEventListener("click", async () => {
    if (MODE === "alt"){
      // go back to main, no password prompt
      MODE = "main";
      await refreshModeData();
      // no modal needed
    } else {
      // MODE === "main": need password to enter alt
      showAuthView("switch-alt");
    }
  });

  // "Settings" button in the quote editor
  openSettingsBtn.addEventListener("click", () => {
    // protected by PASS_SETTINGS
    showSettingsAuthView();
  });

  // Close modal
  closeModalBtn.addEventListener("click", closeBackdrop);
  backdrop.addEventListener("click",(e)=>{
    if (e.target === backdrop) closeBackdrop();
  });

  // Change word button
  nextBtn.addEventListener("click", () => {
    WORD = pickNext(wordEl.textContent);
    wordEl.textContent = WORD;
  });

  // Add a new quote
  addQuote.addEventListener("click", () => {
    const v = newQuote.value.trim();
    if (!v) return;
    QUOTES.push(v);
    newQuote.value = "";
    renderList();
  });

  // Back from settings to list
  backToListBtn.addEventListener("click", () => {
    showListView();
  });

  // Cancel settings auth
  cancelSettingsAuth.addEventListener("click", () => {
    if (listView.style.display === ""){
      showListView();
    } else {
      closeBackdrop();
    }
  });

  // Save settings (token/repo info) locally
  saveSettingsBtn.addEventListener("click", () => {
    saveSettings();
    settingsStatus.textContent = "Saved";
  });

  // Clear token
  clearSettingsBtn.addEventListener("click", () => {
    clearSettings();
    settingsStatus.textContent = "Token cleared";
  });

  // Submit main/alt/admin password
  submitPwd.addEventListener("click", handleAuthSubmit);
  pwdInput.addEventListener("keydown",(e)=>{
    if (e.key==="Enter") handleAuthSubmit();
    if (e.key==="Escape") closeBackdrop();
  });

  // Submit settings password
  submitSettingsPwd.addEventListener("click", handleSettingsAuthSubmit);
  settingsPwd.addEventListener("keydown",(e)=>{
    if (e.key==="Enter") handleSettingsAuthSubmit();
    if (e.key==="Escape") closeBackdrop();
  });

  // Save quotes to GitHub
  saveQuotesBtn.addEventListener("click", handleSaveQuotesToGitHub);

  /* ===========================
     AUTH HANDLERS
     =========================== */

  async function handleAuthSubmit(){
    const entered = pwdInput.value;

    if (currentFlow === "edit-main"){
      if (entered === PASS_MAIN_EDIT){
        MODE = "main";
        await refreshModeData();
        showListView();
      } else {
        err.textContent = "Incorrect password.";
        pwdInput.select();
      }
    }

    else if (currentFlow === "edit-alt"){
      if (entered === PASS_ALT){
        MODE = "alt";
        await refreshModeData();
        showListView();
      } else {
        err.textContent = "Incorrect password.";
        pwdInput.select();
      }
    }

    else if (currentFlow === "switch-alt"){
      if (entered === PASS_ALT){
        MODE = "alt";
        await refreshModeData();
        closeBackdrop();
      } else {
        err.textContent = "Incorrect password.";
        pwdInput.select();
      }
    }
  }

  function handleSettingsAuthSubmit(){
    const entered = settingsPwd.value;
    if (entered === PASS_SETTINGS){
      showSettingsView();
      settingsErr.textContent = "";
    } else {
      settingsErr.textContent = "Incorrect password.";
      settingsPwd.select();
    }
  }

  /* ===========================
     SAVE TO GITHUB + AUTO REFRESH
     =========================== */

  async function handleSaveQuotesToGitHub(){
    saveErr.textContent = "";
    saveOk.textContent = "";

    const owner  = localStorage.getItem("gh_owner")  || ghOwner.value.trim();
    const repo   = localStorage.getItem("gh_repo")   || ghRepo.value.trim();
    const branch = localStorage.getItem("gh_branch") || ghBranch.value.trim() || "main";
    const token  = localStorage.getItem("gh_token")  || ghToken.value.trim();

    if (!owner || !repo || !branch || !token) {
      saveErr.textContent = "Missing GitHub settings or token. Open Settings first.";
      return;
    }

    const filePath = fileForMode(MODE);

    try {
      const content = JSON.stringify(QUOTES, null, 2) + "\n";
      const contentB64 = utf8ToBase64(content);

      let sha = null;
      try {
        sha = await getFileSha(owner, repo, filePath, branch);
      } catch(e){
        // ok if first time
      }

      await putFile(
        owner,
        repo,
        filePath,
        branch,
        "Update " + filePath + " via site admin ("+MODE+")",
        contentB64,
        sha || undefined
      );

      saveOk.textContent = "Saved! ("+filePath+" updated — waiting for rebuild...)";

      // Watch for new SHA, then reload
      const initialHash = await getFileSha(owner, repo, filePath, branch);
      setTimeout(async () => {
        let newHash = initialHash;
        const start = Date.now();
        const maxWait = 2 * 60 * 1000; // 2 minutes

        while (Date.now() - start < maxWait) {
          await new Promise(r => setTimeout(r, 5000)); // every 5s
          try {
            newHash = await getFileSha(owner, repo, filePath, branch);
            if (newHash !== initialHash) {
              saveOk.textContent = "Rebuild detected — refreshing...";
              // IMPORTANT: we do NOT persist MODE now.
              // After reload, site will always come back in main mode.
              setTimeout(()=>location.reload(),800);
              return;
            }
          } catch {}
        }

        saveOk.textContent = "Rebuild not detected yet — refresh manually if needed.";
      }, 10000); // start polling after 10s

    } catch(e){
      saveErr.textContent = e.message || String(e);
    }
  }

  /* ===========================
     INIT
     =========================== */

  // Always start in main mode after refresh
  MODE = "main";
  refreshModeData();
</script>
</body>
</html>
