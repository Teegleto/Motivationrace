<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>race</title>
  <meta name="description" content="Centered word with a button to cycle; admin with persistent quotes via GitHub API and auto-refresh after rebuild." />
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#e5e7eb; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:"Poppins","Inter",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:flex; align-items:center; justify-content:center;
      -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none;
    }
    .container{ display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; gap:2rem; padding:2rem; max-width:90vw; }
    #word{ margin:0; font-weight:700; font-size:clamp(3rem,10vw,6rem); line-height:1.1; word-break:break-word; }
    #nextBtn{
      appearance:none; background:#f8f9fb; border:1px solid var(--muted); color:var(--fg);
      padding:0.9rem 1.4rem; border-radius:999px; font-size:1rem; font-weight:600; cursor:pointer;
      transition:background 120ms ease, transform 120ms ease;
    }
    #nextBtn:hover{ background:#f1f3f7; } #nextBtn:active{ transform:translateY(1px); }

    /* Visible 1-inch admin button (testing). Make invisible later if you want. */
    #adminHotspot{
      position:fixed; right:0.3in; bottom:0.3in;
      width:max(1in,96px); height:max(1in,96px);
      border:2px solid #000; background:rgba(0,0,0,.06);
      cursor:pointer; z-index:2147483647; pointer-events:auto;
    }

    /* Modal */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2147483000; }
    .backdrop[aria-hidden="false"]{ display:flex; }
    .modal{
      width:min(92vw,640px); background:var(--bg); color:var(--fg); border:1px solid var(--muted);
      border-radius:16px; padding:1.25rem; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .modalHeader{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.75rem; }
    .title{ font-size:1.1rem; font-weight:700; margin:0; }
    .closeBtn{
      appearance:none; background:transparent; border:1px solid var(--muted);
      border-radius:10px; padding:.35rem .6rem; cursor:pointer; font-weight:600;
    }
    .modalBody{ display:grid; gap:.9rem; }
    .stack{ display:grid; gap:.5rem; }
    .row{ display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .label{ font-size:.9rem; opacity:.8; }

    /* Inputs/buttons inside modal */
    .input, .token{
      width:100%; padding:.8rem .9rem; border-radius:12px; border:1px solid var(--muted);
      font:inherit; color:var(--fg); background:#fff; caret-color:auto;
      -webkit-user-select:text; -moz-user-select:text; user-select:text; /* allow selecting inside inputs */
    }
    .small{ font-size:.85rem; opacity:.75; }
    .btn{
      appearance:none; border:1px solid var(--muted); background:#f8f9fb; color:var(--fg);
      padding:.7rem 1rem; border-radius:12px; font-weight:600; cursor:pointer; transition:background 120ms ease, transform 120ms ease;
    }
    .btn:hover{ background:#f1f3f7; } .btn:active{ transform:translateY(1px); }
    .danger{ border-color:#ef4444; color:#ef4444; background:#fff; }
    .danger:hover{ background:#fff2f2; }
    .error{ color:#b00020; min-height:1.2em; }
    .ok{ color:#16a34a; min-height:1.2em; }
    .list{ margin:0; padding-left:1.1rem; }
    .list li{ margin:.2rem 0; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .pill{ padding:.2rem .6rem; border:1px solid var(--muted); border-radius:999px; font-size:.8rem; }

    @media (prefers-color-scheme:dark){
      :root{ --bg:#111; --fg:#fff; --muted:#2b2b2b; }
      #nextBtn, .btn{ background:#1e1e1e; border-color:var(--muted); color:#fff; }
      #nextBtn:hover, .btn:hover{ background:#242424; }
      .modal{ background:#151515; }
      .input, .token{ background:#0f0f0f; border-color:var(--muted); color:#fff; }
      .closeBtn{ border-color:var(--muted); color:#fff; }
      .closeBtn:hover{ background:#1e1e1e; }
      #adminHotspot{ border-color:#666; background:rgba(255,255,255,.08); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="word">race</h1>
    <button id="nextBtn" type="button">Change word</button>
  </div>

  <!-- Admin button (testing visible). Make transparent later if desired. -->
  <button id="adminHotspot" aria-label="Open admin"></button>

  <!-- Modal -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <h2 class="title" id="modalTitle">Admin</h2>
        <button class="closeBtn" id="closeModal" type="button">Close</button>
      </div>
      <div class="modalBody" id="modalBody">
        <!-- Auth view -->
        <div class="stack" id="authView">
          <div class="label">Enter password</div>
          <input class="input" id="pwd" type="password" placeholder="••••••••" autocomplete="off" />
          <div class="row">
            <button class="btn" id="submitPwd" type="button">Submit</button>
          </div>
          <div class="error" id="err"></div>
          <div class="small">Tip: after login you can store a GitHub token to save quotes to the repo.</div>
        </div>

        <!-- Quotes view -->
        <div class="stack" id="listView" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="label">Quotes</div>
            <button class="btn" id="openSettings" type="button">Settings</button>
          </div>

          <ul class="list" id="quoteList"></ul>

          <div class="row" style="align-items:flex-start;">
            <input class="input" id="newQuote" type="text" placeholder="Add a new quote…" />
            <button class="btn" id="addQuote" type="button">Add</button>
          </div>

          <div class="row" style="justify-content:space-between;">
            <span class="small">Saving updates writes to <code>quotes.json</code> in this repo.</span>
            <button class="btn" id="saveQuotes" type="button">Save to GitHub</button>
          </div>

          <div class="error" id="saveErr"></div>
          <div class="ok" id="saveOk"></div>
        </div>

        <!-- Settings view (GitHub token) -->
        <div class="stack" id="settingsView" style="display:none;">
          <div class="label">GitHub Settings</div>
          <div class="small">
            Create a <strong>fine-grained personal access token</strong> with Repository permissions → <em>Contents: Read and write</em>, scoped only to this repo.
          </div>

          <input class="token" id="ghToken" type="password" placeholder="GitHub token (stored locally)" />
          <div class="row">
            <input class="input" id="ghOwner" placeholder="GitHub owner (e.g. teegleto)" />
            <input class="input" id="ghRepo" placeholder="Repo name (e.g. race-site)" />
            <input class="input" id="ghBranch" placeholder="Branch (e.g. main)" />
          </div>
          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="saveSettings" type="button">Save settings</button>
            <button class="btn danger" id="clearSettings" type="button">Clear token</button>
            <span class="pill" id="settingsStatus">Not saved</span>
          </div>
          <div class="row">
            <button class="btn" id="backToList" type="button">← Back</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ========= Config (edit admin password) ========= */
  const ADMIN_PASS = "race-admin";

  /* ========= State ========= */
  let QUOTES = [];       // active quotes in memory
  let WORD = "race";     // current word

  /* ========= DOM ========= */
  const wordEl = document.getElementById("word");
  const nextBtn = document.getElementById("nextBtn");

  const hotspot = document.getElementById("adminHotspot");
  const backdrop = document.getElementById("backdrop");
  const closeModalBtn = document.getElementById("closeModal");
  const modalTitle = document.getElementById("modalTitle");

  const authView = document.getElementById("authView");
  const listView = document.getElementById("listView");
  const settingsView = document.getElementById("settingsView");

  const err = document.getElementById("err");
  const pwdInput = document.getElementById("pwd");
  const submitPwd = document.getElementById("submitPwd");

  const quoteList = document.getElementById("quoteList");
  const newQuote = document.getElementById("newQuote");
  const addQuote = document.getElementById("addQuote");
  const saveQuotesBtn = document.getElementById("saveQuotes");
  const saveErr = document.getElementById("saveErr");
  const saveOk = document.getElementById("saveOk");

  const openSettings = document.getElementById("openSettings");
  const backToList = document.getElementById("backToList");
  const ghToken = document.getElementById("ghToken");
  const ghOwner = document.getElementById("ghOwner");
  const ghRepo = document.getElementById("ghRepo");
  const ghBranch = document.getElementById("ghBranch");
  const saveSettingsBtn = document.getElementById("saveSettings");
  const clearSettingsBtn = document.getElementById("clearSettings");
  const settingsStatus = document.getElementById("settingsStatus");

  /* ========= Helpers ========= */
  function pickNext(current) {
    const choices = QUOTES.filter(w => w !== current);
    return choices.length ? choices[Math.floor(Math.random() * choices.length)] : current;
  }

  function renderList() {
    quoteList.innerHTML = "";
    QUOTES.forEach((q, idx) => {
      const li = document.createElement("li");
      const span = document.createElement("span");
      span.textContent = q;

      const del = document.createElement("button");
      del.textContent = "Remove";
      del.className = "btn danger";
      del.addEventListener("click", () => {
        QUOTES.splice(idx, 1);
        renderList();
      });

      li.appendChild(span);
      li.appendChild(del);
      quoteList.appendChild(li);
    });
  }

  function utf8ToBase64(str) {
    const bytes = new TextEncoder().encode(str);
    let binary = "";
    bytes.forEach(b => binary += String.fromCharCode(b));
    return btoa(binary);
  }

  async function fetchQuotes() {
    // Always fetch fresh (cache-bust)
    try {
      const res = await fetch("quotes.json?ts=" + Date.now(), { cache: "no-store" });
      const data = await res.json();
      if (Array.isArray(data) && data.length) {
        QUOTES = data.slice();
      } else {
        QUOTES = ["race","Woke","quack","waw","teenage tech"];
      }
    } catch (e) {
      QUOTES = ["race","Woke","quack","waw","teenage tech"];
    }
    WORD = QUOTES[0] || "race";
    wordEl.textContent = WORD;
  }

  async function getFileSha(owner, repo, path, branch) {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const token = localStorage.getItem("gh_token") || "";
    const res = await fetch(url, {
      headers: {
        "Accept": "application/vnd.github+json",
        ...(token ? { "Authorization": `Bearer ${token}` } : {})
      },
      cache: "no-store"
    });
    if (!res.ok) throw new Error("Failed to get file info: " + res.status);
    const json = await res.json();
    return json.sha;
  }

  async function putFile(owner, repo, path, branch, message, contentB64, sha) {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const token = localStorage.getItem("gh_token") || "";
    if (!token) throw new Error("Missing GitHub token.");

    const body = { message, content: contentB64, branch };
    if (sha) body.sha = sha;

    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error("GitHub save failed: " + res.status + " " + txt);
    }
    return res.json();
  }

  function loadSettings() {
    ghToken.value  = localStorage.getItem("gh_token")   || "";
    ghOwner.value  = localStorage.getItem("gh_owner")   || "";
    ghRepo.value   = localStorage.getItem("gh_repo")    || "";
    ghBranch.value = localStorage.getItem("gh_branch")  || "main";
    settingsStatus.textContent = ghToken.value ? "Token saved" : "Not saved";
  }
  function saveSettings() {
    localStorage.setItem("gh_token",  ghToken.value.trim());
    localStorage.setItem("gh_owner",  ghOwner.value.trim());
    localStorage.setItem("gh_repo",   ghRepo.value.trim());
    localStorage.setItem("gh_branch", ghBranch.value.trim() || "main");
    settingsStatus.textContent = ghToken.value ? "Token saved" : "Not saved";
  }
  function clearSettings() {
    localStorage.removeItem("gh_token");
    settingsStatus.textContent = "Token cleared";
    ghToken.value = "";
  }

  /* ========= UI wiring ========= */
  nextBtn.addEventListener("click", () => {
    WORD = pickNext(wordEl.textContent);
    wordEl.textContent = WORD;
  });

  function openModal() {
    backdrop.setAttribute("aria-hidden", "false");
    err.textContent = "";
    authView.style.display = "";
    listView.style.display = "none";
    settingsView.style.display = "none";
    modalTitle.textContent = "Admin";
    pwdInput.value = "";
    setTimeout(() => pwdInput.focus(), 0);
  }
  function closeModal() { backdrop.setAttribute("aria-hidden", "true"); }

  function showList() {
    authView.style.display = "none";
    listView.style.display = "";
    settingsView.style.display = "none";
    modalTitle.textContent = "Quotes";
    renderList();
  }
  function showSettings() {
    loadSettings();
    authView.style.display = "none";
    listView.style.display = "none";
    settingsView.style.display = "";
    modalTitle.textContent = "Settings";
  }

  // ---- SAVE & AUTO-REFRESH AFTER REBUILD ----
  async function handleSave() {
    saveErr.textContent = "";
    saveOk.textContent = "";
    const owner  = localStorage.getItem("gh_owner")  || ghOwner.value.trim();
    const repo   = localStorage.getItem("gh_repo")   || ghRepo.value.trim();
    const branch = localStorage.getItem("gh_branch") || ghBranch.value.trim() || "main";
    const token  = localStorage.getItem("gh_token")  || ghToken.value.trim();

    if (!owner || !repo || !branch || !token) {
      saveErr.textContent = "Missing GitHub settings or token. Open Settings first.";
      return;
    }

    try {
      const content = JSON.stringify(QUOTES, null, 2) + "\n";
      const contentB64 = utf8ToBase64(content);
      let sha = null;
      try { sha = await getFileSha(owner, repo, "quotes.json", branch); } catch(e){}

      await putFile(
        owner,
        repo,
        "quotes.json",
        branch,
        "Update quotes.json via site admin",
        contentB64,
        sha || undefined
      );

      saveOk.textContent = "Saved! (quotes.json updated — waiting for rebuild...)";

      // Poll for rebuild completion by watching file SHA
      const initialHash = await getFileSha(owner, repo, "quotes.json", branch);
      setTimeout(async () => {
        let newHash = initialHash;
        const start = Date.now();
        const maxWait = 2 * 60 * 1000; // up to 2 minutes
        while (Date.now() - start < maxWait) {
          await new Promise(r => setTimeout(r, 5000)); // every 5s
          try {
            newHash = await getFileSha(owner, repo, "quotes.json", branch);
            if (newHash !== initialHash) {
              saveOk.textContent = "Rebuild detected — refreshing...";
              // small delay so user can see the message
              setTimeout(() => location.reload(), 800);
              return;
            }
          } catch {}
        }
        saveOk.textContent = "Rebuild not detected yet — refresh manually if needed.";
      }, 10000); // start after 10s
    } catch (e) {
      saveErr.textContent = e.message || String(e);
    }
  }

  // Admin interactions
  hotspot.addEventListener("click", openModal);
  closeModalBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });

  submitPwd.addEventListener("click", () => {
    if (pwdInput.value === ADMIN_PASS) showList();
    else { err.textContent = "Incorrect password. Try again."; pwdInput.select(); }
  });
  pwdInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitPwd.click();
    if (e.key === "Escape") closeModal();
  });

  addQuote.addEventListener("click", () => {
    const v = newQuote.value.trim();
    if (!v) return;
    QUOTES.push(v);
    newQuote.value = "";
    renderList();
  });

  saveQuotesBtn.addEventListener("click", handleSave);
  openSettings.addEventListener("click", showSettings);
  backToList.addEventListener("click", showList);
  saveSettingsBtn.addEventListener("click", () => { saveSettings(); settingsStatus.textContent = "Saved"; });
  clearSettingsBtn.addEventListener("click", () => { clearSettings(); });

  // Init
  fetchQuotes();
</script>
</body>
</html>
